<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador Financeiro Pessoal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, getDocsFromCache, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Use os dados do ambiente fornecidos pelo Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;

        setLogLevel('debug'); // Ativa o modo de depuração do Firestore

        window.onload = () => {
            document.getElementById('loading-indicator').classList.add('hidden');
        };

        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Cannot initialize Firebase.");
                    document.getElementById('status-message').textContent = 'Erro: Configuração do Firebase ausente.';
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-id-display').textContent = `ID do Usuário: ${userId}`;
                        setupRealtimeListener();
                    } else {
                        console.log("Usuário desconectado.");
                        isAuthReady = false;
                        userId = null;
                    }
                });

            } catch (e) {
                console.error("Erro ao inicializar o Firebase ou autenticar: ", e);
                document.getElementById('status-message').textContent = `Erro ao inicializar: ${e.message}`;
            }
        }

        function setupRealtimeListener() {
            if (!isAuthReady || !userId) {
                console.warn("Autenticação não pronta. Listener não iniciado.");
                return;
            }
            
            const transactionsPath = `/artifacts/${appId}/users/${userId}/transactions`;
            const transactionsCollection = collection(db, transactionsPath);

            onSnapshot(transactionsCollection, (snapshot) => {
                const transactions = [];
                snapshot.forEach(doc => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort transactions by date descending
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                renderTransactions(transactions);
                updateDashboard(transactions);
            }, (error) => {
                console.error("Erro ao ouvir a coleção de transações: ", error);
                document.getElementById('status-message').textContent = 'Erro ao carregar dados em tempo real.';
            });
        }
        
        function updateDashboard(transactions) {
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIncome - totalExpenses;

            document.getElementById('total-income').textContent = `R$ ${totalIncome.toFixed(2)}`;
            document.getElementById('total-expenses').textContent = `R$ ${totalExpenses.toFixed(2)}`;
            document.getElementById('current-balance').textContent = `R$ ${balance.toFixed(2)}`;
            
            if (balance < 0) {
                document.getElementById('current-balance').classList.add('text-red-500');
                document.getElementById('current-balance').classList.remove('text-green-500');
            } else {
                document.getElementById('current-balance').classList.add('text-green-500');
                document.getElementById('current-balance').classList.remove('text-red-500');
            }
        }
        
        function renderTransactions(transactions) {
            const list = document.getElementById('transactions-list');
            list.innerHTML = '';
            if (transactions.length === 0) {
                list.innerHTML = `<p class="text-gray-500 text-center py-4">Nenhuma transação registrada ainda.</p>`;
                return;
            }

            transactions.forEach(t => {
                const item = document.createElement('li');
                item.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow', 'flex', 'justify-between', 'items-center', 'mb-2');
                const isExpense = t.type === 'expense';
                
                item.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${t.description}</p>
                        <p class="text-sm text-gray-500">${new Date(t.date).toLocaleDateString()}</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <p class="font-bold ${isExpense ? 'text-red-500' : 'text-green-500'}">
                            ${isExpense ? '- ' : '+ '}R$ ${t.amount.toFixed(2)}
                        </p>
                        <button onclick="editTransaction('${t.id}')" class="text-blue-500 hover:text-blue-700 transition duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-3.586 3.586l-7.793 7.793c-.43.43-.648.86-.707 1.343a.5.5 0 00.106.354l1.383 1.383a.5.5 0 00.354.106c.483-.059.913-.277 1.343-.707l7.793-7.793-2.828-2.828z" />
                            </svg>
                        </button>
                        <button onclick="deleteTransaction('${t.id}')" class="text-red-500 hover:text-red-700 transition duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        window.addTransaction = async () => {
            if (!isAuthReady || !userId) {
                showModal('Erro: Autenticação não concluída. Por favor, aguarde.');
                return;
            }

            const description = document.getElementById('description').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const type = document.getElementById('type').value;

            if (!description || isNaN(amount) || amount <= 0) {
                showModal('Por favor, preencha todos os campos com valores válidos.');
                return;
            }
            
            const transactionsPath = `/artifacts/${appId}/users/${userId}/transactions`;
            const transactionsCollection = collection(db, transactionsPath);

            try {
                await addDoc(transactionsCollection, {
                    description: description,
                    amount: amount,
                    type: type,
                    date: new Date().toISOString(),
                });
                document.getElementById('transaction-form').reset();
                showModal('Transação adicionada com sucesso!');
            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                showModal(`Erro ao adicionar transação: ${e.message}`);
            }
        }
        
        window.deleteTransaction = async (id) => {
            if (!isAuthReady || !userId) {
                showModal('Erro: Autenticação não concluída. Por favor, aguarde.');
                return;
            }
            
            const confirmation = confirm("Tem certeza de que deseja excluir esta transação?");
            if (!confirmation) return;

            const docPath = `/artifacts/${appId}/users/${userId}/transactions/${id}`;
            const transactionDoc = doc(db, docPath);

            try {
                await deleteDoc(transactionDoc);
                showModal('Transação excluída com sucesso.');
            } catch (e) {
                console.error("Erro ao excluir documento: ", e);
                showModal(`Erro ao excluir transação: ${e.message}`);
            }
        }
        
        window.editTransaction = async (id) => {
            if (!isAuthReady || !userId) {
                showModal('Erro: Autenticação não concluída. Por favor, aguarde.');
                return;
            }
            
            const docPath = `/artifacts/${appId}/users/${userId}/transactions/${id}`;
            const transactionDoc = doc(db, docPath);
            const docSnap = await getDoc(transactionDoc);

            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('description').value = data.description;
                document.getElementById('amount').value = data.amount;
                document.getElementById('type').value = data.type;

                const form = document.getElementById('transaction-form');
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const newDescription = document.getElementById('description').value;
                    const newAmount = parseFloat(document.getElementById('amount').value);
                    const newType = document.getElementById('type').value;
                    
                    if (!newDescription || isNaN(newAmount) || newAmount <= 0) {
                        showModal('Por favor, preencha todos os campos com valores válidos.');
                        return;
                    }

                    try {
                        await updateDoc(transactionDoc, {
                            description: newDescription,
                            amount: newAmount,
                            type: newType,
                        });
                        form.onsubmit = (event) => { event.preventDefault(); window.addTransaction(); };
                        form.reset();
                        showModal('Transação atualizada com sucesso!');
                    } catch (e) {
                        console.error("Erro ao atualizar documento: ", e);
                        showModal(`Erro ao atualizar transação: ${e.message}`);
                    }
                };
            } else {
                showModal("Transação não encontrada.");
            }
        }

        function showModal(message) {
            const modal = document.getElementById('message-modal');
            document.getElementById('modal-message-text').textContent = message;
            modal.classList.remove('hidden');
        }

        window.closeModal = () => {
            document.getElementById('message-modal').classList.add('hidden');
        }

        initFirebase();
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .container {
            max-width: 800px;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Modal de Mensagem -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="modal-message-text" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <button onclick="closeModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">OK</button>
        </div>
    </div>

    <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-gray-900">Gerenciador Financeiro Pessoal</h1>
            <p id="user-id-display" class="text-sm text-gray-500 mt-2"></p>
            <p id="status-message" class="text-red-500 text-sm mt-1"></p>
            <div id="loading-indicator" class="mt-4">
                <div class="w-8 h-8 border-4 border-dashed rounded-full animate-spin border-blue-600 mx-auto"></div>
                <p class="text-gray-500 text-sm mt-2">Carregando...</p>
            </div>
        </header>

        <!-- Seção do Dashboard -->
        <section class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
            <div class="bg-green-100 p-4 rounded-xl shadow-sm text-center">
                <h3 class="text-lg font-semibold text-green-700">Entradas</h3>
                <p id="total-income" class="text-2xl font-bold text-green-600 mt-2">R$ 0.00</p>
            </div>
            <div class="bg-red-100 p-4 rounded-xl shadow-sm text-center">
                <h3 class="text-lg font-semibold text-red-700">Saídas</h3>
                <p id="total-expenses" class="text-2xl font-bold text-red-600 mt-2">R$ 0.00</p>
            </div>
            <div class="bg-blue-100 p-4 rounded-xl shadow-sm text-center">
                <h3 class="text-lg font-semibold text-blue-700">Saldo Atual</h3>
                <p id="current-balance" class="text-2xl font-bold text-blue-600 mt-2">R$ 0.00</p>
            </div>
        </section>

        <!-- Formulário para Adicionar Transação -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Adicionar Nova Transação</h2>
            <form id="transaction-form" onsubmit="event.preventDefault(); addTransaction();" class="grid grid-cols-1 sm:grid-cols-3 gap-4 bg-gray-50 p-6 rounded-xl shadow-inner">
                <div class="sm:col-span-1">
                    <label for="description" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <input type="text" id="description" placeholder="Ex: Salário, Aluguel" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                </div>
                <div class="sm:col-span-1">
                    <label for="amount" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                    <input type="number" id="amount" step="0.01" min="0" placeholder="Ex: 1500.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                </div>
                <div class="sm:col-span-1">
                    <label for="type" class="block text-sm font-medium text-gray-700">Tipo</label>
                    <select id="type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                        <option value="income">Entrada</option>
                        <option value="expense">Saída</option>
                    </select>
                </div>
                <div class="sm:col-span-3">
                    <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-xl hover:bg-blue-700 transition duration-300 shadow-lg">Adicionar Transação</button>
                </div>
            </form>
        </section>

        <!-- Seção de Histórico de Transações -->
        <section>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Histórico de Transações</h2>
            <ul id="transactions-list">
                <!-- As transações serão renderizadas aqui pelo JavaScript -->
            </ul>
        </section>

    </div>
</body>
</html>
