<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Cole suas credenciais do Firebase aqui.
        // Você pode encontrá-las no console do Firebase > Configurações do Projeto > Seus aplicativos.
        const firebaseConfig = {
  apiKey: "AIzaSyDdZ4NnOsYCn8Mbt4QkY8SiEjnvbwH_ucY",
  authDomain: "planner-financeiro-85c85.firebaseapp.com",
  projectId: "planner-financeiro-85c85",
  storageBucket: "planner-financeiro-85c85.firebasestorage.app",
  messagingSenderId: "481092436809",
  appId: "1:481092436809:web:f63a2a16bd35fd864c5098",
  measurementId: "G-LM7P7ZB655"
};

        let db, auth, userId;
        let unsubscribeFromFirestore;

        const mainContent = document.getElementById('main-content');
        const loginContainer = document.getElementById('login-container');
        const userIdDisplay = document.getElementById('user-id-display');

        const initializeFirebase = async () => {
            if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                console.error("Firebase config is missing. Please add your credentials.");
                loginContainer.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">Falha ao Conectar</h2>
                    <p class="text-gray-600">Por favor, insira suas credenciais do Firebase no código para que o aplicativo funcione.</p>
                `;
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log('User signed in with UID:', userId);
                        userIdDisplay.textContent = `Seu ID de Usuário: ${userId}`;
                        mainContent.classList.remove('hidden');
                        loginContainer.classList.add('hidden');
                        
                        setupFirestoreListener();
                    } else {
                        console.log('No user signed in. Signing in anonymously...');
                        await signInAnonymously(auth);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loginContainer.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">Erro de Conexão</h2>
                    <p class="text-gray-600">Ocorreu um erro ao tentar conectar com o banco de dados. Por favor, tente recarregar a página.</p>
                    <p class="mt-4 text-sm text-gray-500">Detalhes: ${error.message}</p>
                `;
            }
        };

        const setupFirestoreListener = () => {
            if (unsubscribeFromFirestore) {
                unsubscribeFromFirestore();
            }

            const transactionsCollectionRef = collection(db, `users/${userId}/transactions`);
            const q = query(transactionsCollectionRef);

            unsubscribeFromFirestore = onSnapshot(q, (snapshot) => {
                const transactionsData = [];
                snapshot.forEach((doc) => {
                    transactionsData.push({ id: doc.id, ...doc.data() });
                });
                renderTransactions(transactionsData);
            }, (error) => {
                console.error("Error listening to transactions:", error);
            });
        };

        // --- Main App Logic (Moved into functions and adapted for Firestore) ---

        const transactionForm = document.getElementById('transaction-form');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpenseEl = document.getElementById('total-expense');
        const currentBalanceEl = document.getElementById('current-balance');
        const transactionListEl = document.getElementById('transaction-list');
        const pieChartCtx = document.getElementById('finance-chart').getContext('2d');
        const barChartCtx = document.getElementById('expenses-chart').getContext('2d');
        const dynamicAdviceEl = document.getElementById('dynamic-advice');
        const modalOverlay = document.getElementById('custom-modal');
        const modalMessageEl = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        let pieChart;
        let barChart;

        const showCustomModal = (message, isConfirm = false) => {
            modalMessageEl.textContent = message;
            modalCancelBtn.classList.toggle('hidden', !isConfirm);
            modalOverlay.style.display = 'flex';
            return new Promise((resolve) => {
                modalOkBtn.onclick = () => {
                    modalOverlay.style.display = 'none';
                    resolve(true);
                };
                modalCancelBtn.onclick = () => {
                    modalOverlay.style.display = 'none';
                    resolve(false);
                };
            });
        };
    
        const getAdvice = (category) => {
            switch (category) {
                case 'alimentacao':
                    return 'Seu maior gasto é com alimentação. Tente cozinhar mais em casa, levar marmita para o trabalho e evite pedir delivery com frequência. Isso pode gerar uma grande economia no final do mês!';
                case 'moradia':
                    return 'O gasto com moradia é o mais expressivo. Avalie se o aluguel é proporcional à sua renda. Considere renegociar o valor ou procurar por uma opção mais em conta.';
                case 'transporte':
                    return 'Seu maior gasto é com transporte. Pense em usar mais transporte público, bicicleta ou caronas. Manter o carro exige muitos gastos com combustível e manutenção.';
                case 'lazer':
                    return 'O lazer consome a maior parte de seus gastos. Procure por atividades gratuitas ou de baixo custo, como parques, bibliotecas ou eventos culturais. Planeje os gastos com antecedência.';
                case 'saude':
                    return 'Seu maior gasto é com saúde. Verifique se seu plano de saúde é o mais adequado. Pesquisar por farmácias com preços mais acessíveis e sempre pedir a nota fiscal pode ajudar.';
                case 'educacao':
                    return 'Educação é seu maior gasto. Verifique se existem bolsas de estudo, descontos ou alternativas de cursos online mais baratos. Invista em conhecimento, mas de forma inteligente.';
                case 'compras':
                    return 'O gasto com compras é o mais expressivo. Analise o que você compra. Faça uma lista antes de sair e evite compras por impulso. Desative notificações de promoções.';
                default:
                    return 'Continue registrando seus gastos para receber conselhos personalizados!';
            }
        };

        const renderTransactions = (transactions) => {
            transactionListEl.innerHTML = '';
            let totalIncome = 0;
            let totalExpense = 0;
            const expenseCategories = {};
    
            transactions.forEach((t) => {
                const li = document.createElement('li');
                li.className = `flex justify-between items-center p-3 rounded-lg shadow-sm
                    ${t.type === 'income' ? 'bg-green-50 border-l-4 border-green-400' : 'bg-red-50 border-l-4 border-red-400'}`;
                
                const sign = t.type === 'income' ? '+' : '-';
                const color = t.type === 'income' ? 'text-green-600' : 'text-red-600';
                const categoryText = t.category && t.type === 'expense' && t.category !== 'none' ? ` (${t.category.charAt(0).toUpperCase() + t.category.slice(1)})` : '';
    
                li.innerHTML = `
                    <span class="text-gray-800">${t.description}${categoryText}</span>
                    <span class="font-medium ${color}">${sign} R$ ${t.amount.toFixed(2)}</span>
                    <button onclick="deleteTransaction('${t.id}')" class="text-gray-400 hover:text-red-500 transition-colors ml-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                transactionListEl.appendChild(li);
    
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                    if (t.category && t.category !== 'none') {
                        expenseCategories[t.category] = (expenseCategories[t.category] || 0) + t.amount;
                    }
                }
            });
    
            const balance = totalIncome - totalExpense;
            totalIncomeEl.textContent = `R$ ${totalIncome.toFixed(2)}`;
            totalExpenseEl.textContent = `R$ ${totalExpense.toFixed(2)}`;
            currentBalanceEl.textContent = `R$ ${balance.toFixed(2)}`;
            currentBalanceEl.style.color = balance >= 0 ? '#27ae60' : '#e74c3c';
    
            updatePieChart(totalIncome, totalExpense);
            updateBarChart(expenseCategories);
            updateAdvice(expenseCategories);
        };

        const updateAdvice = (expenseCategories) => {
            if (Object.keys(expenseCategories).length === 0) {
                dynamicAdviceEl.innerHTML = '<p>Comece a adicionar suas despesas para receber conselhos personalizados!</p>';
                return;
            }

            let maxCategory = null;
            let maxAmount = 0;

            for (const category in expenseCategories) {
                if (expenseCategories[category] > maxAmount) {
                    maxAmount = expenseCategories[category];
                    maxCategory = category;
                }
            }
            
            if (maxCategory) {
                const adviceText = getAdvice(maxCategory);
                dynamicAdviceEl.innerHTML = `<p class="font-bold text-yellow-900">Conselho de Economia:</p><p>${adviceText}</p>`;
            }
        };
    
        const updatePieChart = (income, expense) => {
            if (pieChart) {
                pieChart.destroy();
            }
    
            pieChart = new Chart(pieChartCtx, {
                type: 'pie',
                data: {
                    labels: ['Receitas', 'Despesas'],
                    datasets: [{
                        data: [income, expense],
                        backgroundColor: ['#34d399', '#f87171'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Inter',
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += `R$ ${context.parsed.toFixed(2)}`;
                                    return label;
                                }
                            },
                            bodyFont: {
                                family: 'Inter',
                            }
                        }
                    }
                }
            });
        };

        const updateBarChart = (expenseCategories) => {
            if (barChart) {
                barChart.destroy();
            }
            
            // Sort categories by amount to show the most expensive first
            const sortedCategories = Object.entries(expenseCategories).sort(([, a], [, b]) => b - a);
            const labels = sortedCategories.map(([category]) => category.charAt(0).toUpperCase() + category.slice(1));
            const data = sortedCategories.map(([, amount]) => amount);
            const barColors = [
                'rgba(248, 114, 96, 0.8)',
                'rgba(251, 191, 36, 0.8)',
                'rgba(96, 165, 250, 0.8)',
                'rgba(74, 222, 128, 0.8)',
                'rgba(129, 140, 248, 0.8)',
                'rgba(236, 72, 153, 0.8)',
                'rgba(253, 164, 175, 0.8)',
                'rgba(250, 204, 21, 0.8)'
            ];
    
            barChart = new Chart(barChartCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total de Gastos (R$)',
                        data: data,
                        backgroundColor: barColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Valor (R$)',
                                font: { family: 'Inter' }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Categoria',
                                font: { family: 'Inter' }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += `R$ ${context.parsed.y.toFixed(2)}`;
                                    return label;
                                }
                            },
                            bodyFont: {
                                family: 'Inter',
                            }
                        }
                    }
                }
            });
        };
    
        const addTransaction = async (e) => {
            e.preventDefault();
            if (!db || !userId) {
                await showCustomModal('Erro: Usuário não autenticado. Por favor, recarregue a página.', false);
                return;
            }

            const description = document.getElementById('description').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const type = document.querySelector('input[name="type"]:checked').value;
            const category = document.getElementById('category').value;
    
            if (description && !isNaN(amount) && amount > 0) {
                const newTransaction = { description, amount, type, category, timestamp: new Date() };
                try {
                    const transactionsCollectionRef = collection(db, `users/${userId}/transactions`);
                    await addDoc(transactionsCollectionRef, newTransaction);
                    document.getElementById('transaction-form').reset();
                } catch (e) {
                    console.error("Error adding document: ", e);
                    await showCustomModal('Erro ao adicionar transação. Por favor, tente novamente.', false);
                }
            } else {
                await showCustomModal('Por favor, preencha todos os campos com valores válidos.', false);
            }
        };
    
        window.deleteTransaction = async (docId) => {
            if (!db || !userId) {
                await showCustomModal('Erro: Usuário não autenticado. Por favor, recarregue a página.', false);
                return;
            }
            const confirmed = await showCustomModal('Tem certeza que deseja excluir esta transação?', true);
            if (confirmed) {
                try {
                    const docRef = doc(db, `users/${userId}/transactions`, docId);
                    await deleteDoc(docRef);
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    await showCustomModal('Erro ao excluir transação. Por favor, tente novamente.', false);
                }
            }
        };
    
        transactionForm.addEventListener('submit', addTransaction);
        
        initializeFirebase();
    </script>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex items-center justify-center">

    <div id="login-container" class="text-center p-8 bg-white rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-4">Carregando seu Planner...</h2>
        <p class="text-gray-600">Aguarde enquanto preparamos seu ambiente financeiro pessoal.</p>
        <div class="mt-4 flex justify-center items-center">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
    </div>

    <div id="main-content" class="container mx-auto p-6 bg-white shadow-xl rounded-2xl max-w-4xl flex flex-col md:flex-row hidden">
        
        <!-- Painel Esquerdo -->
        <div class="md:w-1/2 md:pr-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center md:text-left">Planner Financeiro Pessoal</h1>
            <p id="user-id-display" class="text-sm text-gray-500 mb-6 text-center md:text-left break-all"></p>

            <!-- Resumo Financeiro -->
            <div class="mb-6 grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                <div class="bg-blue-100 p-4 rounded-lg shadow-sm">
                    <p class="text-sm text-blue-800 font-medium">Saldo Atual</p>
                    <p id="current-balance" class="text-2xl font-bold text-blue-700 mt-1">R$ 0,00</p>
                </div>
                <div class="bg-green-100 p-4 rounded-lg shadow-sm">
                    <p class="text-sm text-green-800 font-medium">Total de Receitas</p>
                    <p id="total-income" class="text-2xl font-bold text-green-700 mt-1">R$ 0,00</p>
                </div>
                <div class="bg-red-100 p-4 rounded-lg shadow-sm">
                    <p class="text-sm text-red-800 font-medium">Total de Despesas</p>
                    <p id="total-expense" class="text-2xl font-bold text-red-700 mt-1">R$ 0,00</p>
                </div>
            </div>

            <!-- Formulário de Transação -->
            <div class="p-6 bg-gray-50 rounded-lg shadow-inner mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Adicionar Nova Transação</h2>
                <form id="transaction-form" class="space-y-4">
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">Descrição:</label>
                        <input type="text" id="description" placeholder="Ex: Salário, Aluguel, Supermercado" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    </div>
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700">Valor (R$):</label>
                        <input type="number" id="amount" step="0.01" required
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700">Categoria (para despesas):</label>
                        <select id="category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            <option value="none">N/A</option>
                            <option value="alimentacao">Alimentação</option>
                            <option value="moradia">Moradia</option>
                            <option value="transporte">Transporte</option>
                            <option value="lazer">Lazer</option>
                            <option value="saude">Saúde</option>
                            <option value="educacao">Educação</option>
                            <option value="compras">Compras</option>
                            <option value="outros">Outros</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="type" value="income" checked
                                   class="form-radio text-green-600 focus:ring-green-500">
                            <span class="ml-2 text-sm text-gray-700">Receita</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="type" value="expense"
                                   class="form-radio text-red-600 focus:ring-red-500">
                            <span class="ml-2 text-sm text-gray-700">Despesa</span>
                        </label>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-md font-semibold hover:bg-indigo-700 transition-colors">
                        Adicionar Transação
                    </button>
                </form>
            </div>
            
            <!-- Histórico de Transações -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Histórico</h2>
                <ul id="transaction-list" class="space-y-2">
                    <!-- Transações serão adicionadas aqui -->
                </ul>
            </div>
            
            <!-- Sugestões de Economia -->
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Dicas de Economia</h2>
                <div id="dynamic-advice" class="p-4 bg-yellow-50 rounded-lg border border-yellow-200 text-yellow-800">
                    <p>Comece a adicionar suas despesas para receber conselhos personalizados!</p>
                </div>
                <ul class="list-disc list-inside space-y-2 text-gray-600 mt-4">
                    <li>Crie um orçamento mensal e defina limites para cada categoria.</li>
                    <li>Guarde uma porcentagem fixa do seu salário assim que ele cair na conta.</li>
                    <li>Evite compras por impulso e sempre pesquise preços.</li>
                    <li>Reduza gastos com assinaturas e serviços que você não usa.</li>
                </ul>
            </div>
        </div>

        <!-- Painel Direito -->
        <div class="md:w-1/2 mt-8 md:mt-0 flex flex-col items-center justify-center">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Distribuição Financeira</h2>
            <div class="relative w-full h-80">
                <canvas id="finance-chart"></canvas>
            </div>
            <h2 class="text-xl font-semibold text-gray-700 mb-4 mt-8 text-center">Perspectiva de Gastos por Categoria</h2>
            <div class="relative w-full h-80">
                <canvas id="expenses-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal">
            <p id="modal-message" class="text-lg text-gray-800 mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="modal-ok-btn" class="bg-indigo-600 text-white py-2 px-6 rounded-md font-semibold hover:bg-indigo-700 transition-colors">OK</button>
                <button id="modal-cancel-btn" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md font-semibold hover:bg-gray-400 transition-colors hidden">Cancelar</button>
            </div>
        </div>
    </div>
</body>
</html>
